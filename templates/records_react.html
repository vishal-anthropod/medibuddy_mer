<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>MediBuddy Records</title>
  <link rel="stylesheet" href="/static/styles.css?v={{ asset_v|default('0') }}" />
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    :root{--bg:#0f172a;--panel:#ffffff;--muted:#64748b;--border:#e2e8f0;--chip:#f1f5f9;--shadow:0 8px 24px rgba(2,6,23,.06)}
    body{background:#f8fafc}
    .container{padding:20px;max-width:1200px;margin:0 auto}
    .card{margin-bottom:16px;background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow)}
    .card h3{margin:0 0 12px 0}
    .card .section{padding:16px}
    .grid{display:grid;gap:16px}
    /* Pill chips for top summary - aligned and responsive */
    .chip{
      display:inline-flex;
      align-items:center;
      gap:6px; /* uniform spacing between icon and text */
      background:var(--chip);
      padding:6px 12px; /* vertical rhythm */
      border-radius:999px;
      color:#0f172a;
      font-weight:600;
      border:1px solid var(--border);
      line-height:1; /* prevent text baseline drift */
      vertical-align:middle;
      white-space:nowrap;
    }
    .chip-icon{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:16px; height:16px; /* consistent icon size */
      flex:0 0 16px; /* prevent squish/grow */
    }
    .chip-icon svg{ display:block; width:100%; height:100%; }
    /* Responsive adjustments */
    @media (max-width: 600px){
      .chip{ gap:4px; padding:6px 10px; font-size:13px }
      .summary{ gap:8px }
    }
    .muted{color:var(--muted)}
    .pill{padding:2px 8px;border-radius:999px;border:1px solid var(--border);background:#f8fafc;font-size:12px}
    .toolbar{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;border-bottom:1px solid var(--border);background:var(--panel)}
    .toolbar .title{font-weight:800;color:#0f172a}
    .toolbar .btn{background:#2563eb;color:#fff;border:none;border-radius:8px;padding:8px 12px;cursor:pointer}
    .toolbar .btn:hover{filter:brightness(.95)}
    .input{transition:border .2s}
    .input:focus{outline:none;border-color:#94a3b8}
    table{border-collapse:separate;border-spacing:0;width:100%}
    thead th{font-size:12px;text-transform:uppercase;color:var(--muted);background:#f8fafc;border-bottom:1px solid var(--border);padding:10px}
    tbody td{padding:10px;border-bottom:1px solid var(--border);font-size:14px}
    tbody tr:hover{background:#f8fafc}
    .summary{display:flex;flex-wrap:wrap;gap:12px}
    .badge-red{background:#fee2e2;border-color:#fecaca;color:#991b1b}
    .badge-orange{background:#ffedd5;border-color:#fed7aa;color:#9a3412}
    .badge-yellow{background:#fef9c3;border-color:#fde68a;color:#854d0e}
    .badge-blue{background:#dbeafe;border-color:#bfdbfe;color:#1e40af}
    .badge-green{background:#dcfce7;border-color:#bbf7d0;color:#065f46}
    .actions a.btn{display:inline-flex;align-items:center;gap:6px}
  </style>
</head>
<body>
  <div class="topbar" style="justify-content:space-between;padding:12px 24px">
    <div style="font-weight:700">MER Quality Dashboard</div>
    <a class="btn" href="/">Back</a>
  </div>
  <div id="root" class="container">Loading...</div>
  {% raw %}
  <script type="text/babel" data-presets="env,react">
    const {useState, useMemo, useEffect} = React;

    const Icon = ({name, size=16, stroke=2}) => {
      const common = {fill:'none', stroke:'currentColor', strokeWidth:stroke, strokeLinecap:'round', strokeLinejoin:'round', viewBox:'0 0 24 24'};
      const paths = {
        x: (<path d="M18 6L6 18M6 6l12 12"/>),
        alert: (<><path d="M12 9v4"/><path d="M12 17h.01"/><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/></>),
        flag: (<path d="M4 15s1-1 4-1 5 2 8 2V5s-3-2-6-2-6 2-6 2z"/>),
        wrench: (<path d="M14.7 6.3a4 4 0 1 0-5.66 5.66l-6.04 6.04a2 2 0 0 0 2.83 2.83l6.04-6.04a4 4 0 0 0 2.83-8.49z"/>),
        check: (<path d="M20 6L9 17l-5-5"/>),
        search: (<><circle cx="11" cy="11" r="7"/><path d="M21 21l-4.3-4.3"/></>)
      };
      return (
        <span className="chip-icon" style={{width:size, height:size}}>
          <svg {...common}>{paths[name]}</svg>
        </span>
      );
    };

    function RecordsApp(){
      const [records, setRecords] = useState([]);
      const [loading, setLoading] = useState(true);
      const [searchTerm, setSearchTerm] = useState('');
      const [filterCategory, setFilterCategory] = useState('all');

      useEffect(()=>{
        (async()=>{
          try{
            const r = await fetch('/api/records_dashboard');
            const j = await r.json();
            setRecords(j.records||[]);
          }catch(e){ console.error(e); }
          setLoading(false);
        })();
      },[]);

      const categoryCounts = useMemo(()=>{
        const counts = {assignback:0, ops_attention:0, flags:0, tech_issues:0, pass:0};
        (records||[]).forEach(r=>{ if(counts[r.category]!==undefined) counts[r.category]++; });
        return counts;
      },[records]);

      const insurerStats = useMemo(()=>{
        const stats={};
        (records||[]).forEach(r=>{
          const name=r.insurerName||'-';
          stats[name] = stats[name]||{total:0,assignback:0,ops_attention:0,flags:0,tech_issues:0,pass:0,avgAccuracy:0,avgScore:0};
          const st=stats[name]; st.total++; st[r.category]++; st.avgAccuracy += (r.accuracy||0); st.avgScore += (r.qcScore||0);
        });
        return Object.entries(stats).map(([name,st])=>({name, ...st, avgAccuracy: (st.avgAccuracy/st.total).toFixed(1), avgScore: Math.round(st.avgScore/st.total)}));
      },[records]);

      const doctorStats = useMemo(()=>{
        const stats={};
        (records||[]).forEach(r=>{
          const name=r.doctorName||'-';
          stats[name] = stats[name]||{total:0,assignback:0,ops_attention:0,flags:0,tech_issues:0,pass:0,avgAccuracy:0,avgScore:0};
          const st=stats[name]; st.total++; st[r.category]++; st.avgAccuracy += (r.accuracy||0); st.avgScore += (r.qcScore||0);
        });
        return Object.entries(stats).map(([name,st])=>({name, ...st, avgAccuracy: (st.avgAccuracy/st.total).toFixed(1), avgScore: Math.round(st.avgScore/st.total)}));
      },[records]);

      const filteredRecords = useMemo(()=>{
        return (records||[]).filter(r=>{
          const s=(searchTerm||'').toLowerCase();
          const matchesSearch = (r.customerName||'-').toLowerCase().includes(s) || (r.id||'').toLowerCase().includes(s);
          const matchesCategory = filterCategory==='all' || r.category===filterCategory;
          return matchesSearch && matchesCategory;
        });
      },[records, searchTerm, filterCategory]);

      if(loading){ return <div>Loading...</div>; }

      return (
        <div className="grid">
          <div className="card section">
            <div className="summary">
              <span className="chip"><Icon name="search"/> Total Records <span className="pill">{records.length}</span></span>
              <span className="chip badge-red"><Icon name="x"/> Assignback <span className="pill">{categoryCounts.assignback}</span></span>
              <span className="chip badge-orange"><Icon name="alert"/> Ops Attention <span className="pill">{categoryCounts.ops_attention}</span></span>
              <span className="chip badge-yellow"><Icon name="flag"/> Flags <span className="pill">{categoryCounts.flags}</span></span>
              <span className="chip badge-blue"><Icon name="wrench"/> Tech Issues <span className="pill">{categoryCounts.tech_issues}</span></span>
              <span className="chip badge-green"><Icon name="check"/> Pass <span className="pill">{categoryCounts.pass}</span></span>
            </div>
          </div>

          <div className="card section" style={{display:'flex',gap:12,alignItems:'center'}}>
            <div style={{position:'relative',flex:1,maxWidth:360}}>
              <span style={{position:'absolute',left:10,top:10,color:'#94a3b8'}}><Icon name="search"/></span>
              <input value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} placeholder="Search MER ID or Customer..." className="input" style={{padding:'10px 12px 10px 36px',border:'1px solid #e5e7eb',borderRadius:8,width:'100%'}} />
            </div>
            <select value={filterCategory} onChange={e=>setFilterCategory(e.target.value)} className="input" style={{padding:'10px 12px',border:'1px solid #e5e7eb',borderRadius:8}}>
              <option value="all">All Categories</option>
              <option value="assignback">Assignback</option>
              <option value="ops_attention">Ops Attention</option>
              <option value="flags">Flags</option>
              <option value="tech_issues">Tech Issues</option>
              <option value="pass">Pass</option>
            </select>
          </div>

          <div className="card section">
            <h3 style={{marginBottom:8}}>Insurer-wise Statistics</h3>
            <div style={{overflowX:'auto'}}>
              <table className="w-full">
                <thead><tr><th>Insurer</th><th>Total</th><th>Assignback</th><th>Ops Attn</th><th>Flags</th><th>Tech</th><th>Pass</th><th>Avg Accuracy</th><th>Avg Score</th></tr></thead>
                <tbody>
                {insurerStats.map((st,i)=> (
                  <tr key={i}><td>{st.name}</td><td className="text-center">{st.total}</td><td className="text-center">{st.assignback||'-'}</td><td className="text-center">{st.ops_attention||'-'}</td><td className="text-center">{st.flags||'-'}</td><td className="text-center">{st.tech_issues||'-'}</td><td className="text-center">{st.pass||'-'}</td><td className="text-center">{st.avgAccuracy}%</td><td className="text-center">{st.avgScore}</td></tr>
                ))}
                </tbody>
              </table>
            </div>
          </div>

          <div className="card section">
            <h3 style={{marginBottom:8}}>Doctor-wise Statistics</h3>
            <div style={{overflowX:'auto'}}>
              <table className="w-full">
                <thead><tr><th>Doctor</th><th>Total</th><th>Assignback</th><th>Ops Attn</th><th>Flags</th><th>Tech</th><th>Pass</th><th>Avg Accuracy</th><th>Avg Score</th></tr></thead>
                <tbody>
                {doctorStats.map((st,i)=> (
                  <tr key={i}><td>{st.name}</td><td className="text-center">{st.total}</td><td className="text-center">{st.assignback||'-'}</td><td className="text-center">{st.ops_attention||'-'}</td><td className="text-center">{st.flags||'-'}</td><td className="text-center">{st.tech_issues||'-'}</td><td className="text-center">{st.pass||'-'}</td><td className="text-center">{st.avgAccuracy}%</td><td className="text-center">{st.avgScore}</td></tr>
                ))}
                </tbody>
              </table>
            </div>
          </div>

          <div className="card section">
            <h3 style={{marginBottom:8}}>MER Records ({filteredRecords.length})</h3>
            <div style={{overflowX:'auto'}}>
              <table className="w-full">
                <thead><tr><th>MER ID</th><th>Customer</th><th>Doctor</th><th>Insurer</th><th>Category</th><th>Accuracy</th><th>Questions</th><th>Action</th></tr></thead>
                <tbody>
                {filteredRecords.map(r=> (
                  <tr key={r.id}>
                    <td>{r.id}</td>
                    <td>{r.customerName}</td>
                    <td>{r.doctorName}</td>
                    <td>{r.insurerName}</td>
                    <td><span className="pill">{r.category}</span></td>
                    <td className="text-center">{Number(r.accuracy ?? 0).toFixed(1)}%</td>
                    <td className="text-center">{r.questionsAsked}</td>
                    <td className="text-center actions"><a href={`/record/${encodeURIComponent(r.id)}`} className="btn">Open</a></td>
                  </tr>
                ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<RecordsApp />);
  </script>
  {% endraw %}
</body>
</html>

